<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoinPilot AI - æ§åˆ¶å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .btn-disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        
        <!-- æ¨™é¡Œ -->
        <header class="text-center mb-10">
            <h1 class="text-4xl font-bold text-yellow-400 mb-2">ğŸª™ CoinPilot AI</h1>
            <p class="text-gray-400">åŠ å¯†è²¨å¹£è‡ªå‹•åˆ†æèˆ‡å‡ºç‰ˆç³»çµ±</p>
        </header>

        <!-- ç‹€æ…‹å¡ç‰‡ -->
        <div class="bg-gray-800 rounded-xl p-6 mb-8 shadow-lg">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <span class="mr-2">ğŸ“Š</span> ç³»çµ±ç‹€æ…‹
            </h2>
            <div id="status-content" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-gray-700 rounded-lg p-4">
                    <div class="text-sm text-gray-400">è³‡æ–™ç‹€æ…‹</div>
                    <div id="data-status" class="text-lg font-medium mt-1">è¼‰å…¥ä¸­...</div>
                </div>
                <div class="bg-gray-700 rounded-lg p-4">
                    <div class="text-sm text-gray-400">BTC åƒ¹æ ¼</div>
                    <div id="btc-price" class="text-lg font-medium mt-1 text-green-400">--</div>
                </div>
                <div class="bg-gray-700 rounded-lg p-4">
                    <div class="text-sm text-gray-400">ä»Šæ—¥æ–‡ç« </div>
                    <div id="article-status" class="text-lg font-medium mt-1">--</div>
                </div>
            </div>
        </div>

        <!-- æ§åˆ¶æŒ‰éˆ• -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            
            <!-- æŠ“å–è³‡æ–™ -->
            <button 
                id="btn-collect" 
                onclick="collectData()"
                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-6 px-6 rounded-xl shadow-lg transition-all duration-200 flex flex-col items-center justify-center space-y-2"
            >
                <span class="text-3xl">ğŸ”„</span>
                <span class="text-lg">æŠ“å–è³‡æ–™</span>
                <span class="text-xs text-blue-200">æ¡é›†æœ€æ–°å¸‚å ´æ•¸æ“š</span>
            </button>

            <!-- æŸ¥çœ‹å ±å‘Š -->
            <button 
                id="btn-report" 
                onclick="showReport()"
                class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-6 px-6 rounded-xl shadow-lg transition-all duration-200 flex flex-col items-center justify-center space-y-2"
            >
                <span class="text-3xl">ğŸ“Š</span>
                <span class="text-lg">æŸ¥çœ‹å ±å‘Š</span>
                <span class="text-xs text-purple-200">é¡¯ç¤ºæ¡é›†çš„æ•¸æ“š</span>
            </button>

            <!-- ç™¼å¸ƒç¶²ç«™ -->
            <button 
                id="btn-publish" 
                onclick="publishSite()"
                class="bg-green-600 hover:bg-green-700 text-white font-bold py-6 px-6 rounded-xl shadow-lg transition-all duration-200 flex flex-col items-center justify-center space-y-2"
            >
                <span class="text-3xl">ğŸš€</span>
                <span class="text-lg">ç™¼å¸ƒç¶²ç«™</span>
                <span class="text-xs text-green-200">æ¡é›†â†’ç”Ÿæˆâ†’å»ºç½®â†’æ¨é€</span>
            </button>

        </div>

        <!-- åŸ·è¡Œç‹€æ…‹ -->
        <div id="task-status" class="bg-gray-800 rounded-xl p-6 mb-8 shadow-lg hidden">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <span class="mr-2" id="task-icon">â³</span>
                <span id="task-title">åŸ·è¡Œä¸­</span>
            </h2>
            <div id="task-message" class="text-gray-300 mb-4">--</div>
            <div id="task-steps" class="space-y-2"></div>
        </div>

        <!-- å ±å‘Šé è¦½ -->
        <div id="report-panel" class="bg-gray-800 rounded-xl p-6 shadow-lg hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold flex items-center">
                    <span class="mr-2">ğŸ“‹</span> æ¡é›†å ±å‘Š
                </h2>
                <button 
                    onclick="hideReport()" 
                    class="text-gray-400 hover:text-white"
                >
                    âœ• é—œé–‰
                </button>
            </div>
            
            <!-- å ±å‘Šæ‘˜è¦ -->
            <div id="report-summary" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            </div>
            
            <!-- å ±å‘Šè©³ç´° JSON -->
            <details class="bg-gray-700 rounded-lg">
                <summary class="p-4 cursor-pointer text-gray-300 hover:text-white">
                    æŸ¥çœ‹å®Œæ•´ JSON è³‡æ–™
                </summary>
                <pre id="report-json" class="p-4 text-xs text-gray-400 overflow-auto max-h-96"></pre>
            </details>
        </div>

        <!-- é å°¾ -->
        <footer class="text-center mt-10 text-gray-500 text-sm">
            <p>CoinPilot AI v1.0.0 | 
                <a href="https://github.com/Pie-ye/coinpilet" class="text-blue-400 hover:underline" target="_blank">GitHub</a>
            </p>
        </footer>

    </div>

    <script>
        // è‡ªå‹•åµæ¸¬ API ä½å€
        const API_BASE = window.location.origin;
        
        // å…±ç”¨ fetch è¨­å®š
        async function apiCall(endpoint, options = {}) {
            const url = `${API_BASE}${endpoint}`;
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                },
                ...options,
            };
            
            try {
                const response = await fetch(url, defaultOptions);
                return response;
            } catch (err) {
                console.error(`API call failed: ${endpoint}`, err);
                throw err;
            }
        }
        
        // ============================================
        // ç‹€æ…‹æ›´æ–°
        // ============================================
        
        async function refreshStatus() {
            try {
                const res = await apiCall('/api/status');
                const data = await res.json();
                
                // è³‡æ–™ç‹€æ…‹
                const dataStatus = document.getElementById('data-status');
                if (data.data_exists) {
                    dataStatus.textContent = 'âœ… å·²æ¡é›†';
                    dataStatus.classList.add('text-green-400');
                    dataStatus.classList.remove('text-red-400');
                } else {
                    dataStatus.textContent = 'âŒ å°šæœªæ¡é›†';
                    dataStatus.classList.add('text-red-400');
                    dataStatus.classList.remove('text-green-400');
                }
                
                // BTC åƒ¹æ ¼
                const btcPrice = document.getElementById('btc-price');
                if (data.btc_price) {
                    btcPrice.textContent = `$${data.btc_price.toLocaleString()}`;
                } else {
                    btcPrice.textContent = '--';
                }
                
                // æ–‡ç« ç‹€æ…‹
                const articleStatus = document.getElementById('article-status');
                if (data.article_exists) {
                    articleStatus.textContent = `âœ… ${data.article_date}`;
                    articleStatus.classList.add('text-green-400');
                    articleStatus.classList.remove('text-red-400');
                } else {
                    articleStatus.textContent = 'âŒ å°šæœªç”Ÿæˆ';
                    articleStatus.classList.add('text-red-400');
                    articleStatus.classList.remove('text-green-400');
                }
                
            } catch (err) {
                console.error('Failed to refresh status:', err);
            }
        }
        
        // ============================================
        // æŒ‰éˆ•æ§åˆ¶
        // ============================================
        
        function setButtonsEnabled(enabled) {
            const buttons = ['btn-collect', 'btn-report', 'btn-publish'];
            buttons.forEach(id => {
                const btn = document.getElementById(id);
                if (enabled) {
                    btn.classList.remove('btn-disabled');
                    btn.disabled = false;
                } else {
                    btn.classList.add('btn-disabled');
                    btn.disabled = true;
                }
            });
        }
        
        function showTaskStatus(icon, title, message, isRunning = false) {
            const panel = document.getElementById('task-status');
            panel.classList.remove('hidden');
            
            document.getElementById('task-icon').textContent = icon;
            document.getElementById('task-title').textContent = title;
            document.getElementById('task-message').textContent = message;
            
            if (isRunning) {
                document.getElementById('task-message').classList.add('loading');
            } else {
                document.getElementById('task-message').classList.remove('loading');
            }
        }
        
        function showTaskSteps(steps) {
            const container = document.getElementById('task-steps');
            container.innerHTML = steps.map(step => `
                <div class="text-sm ${step.startsWith('âœ…') ? 'text-green-400' : step.startsWith('âŒ') ? 'text-red-400' : 'text-yellow-400'}">
                    ${step}
                </div>
            `).join('');
        }
        
        // ============================================
        // API å‘¼å«
        // ============================================
        
        async function collectData() {
            setButtonsEnabled(false);
            showTaskStatus('â³', 'è³‡æ–™æ¡é›†ä¸­...', 'æ­£åœ¨å¾å„è³‡æ–™ä¾†æºæ¡é›†æœ€æ–°æ•¸æ“š...ï¼ˆç´„éœ€ 10-30 ç§’ï¼‰', true);
            document.getElementById('task-steps').innerHTML = '';
            
            try {
                const res = await apiCall('/api/fetch-data', { method: 'POST' });
                const data = await res.json();
                
                if (res.ok) {
                    showTaskStatus('âœ…', 'æ¡é›†å®Œæˆ', data.message || 'è³‡æ–™å·²æˆåŠŸæ¡é›†');
                } else {
                    showTaskStatus('âŒ', 'æ¡é›†å¤±æ•—', data.detail || 'ç™¼ç”ŸéŒ¯èª¤');
                }
            } catch (err) {
                console.error('Collect error:', err);
                showTaskStatus('âŒ', 'æ¡é›†å¤±æ•—', `ç¶²è·¯éŒ¯èª¤: ${err.message}`);
            } finally {
                setButtonsEnabled(true);
                refreshStatus();
            }
        }
        
        async function showReport() {
            const panel = document.getElementById('report-panel');
            
            try {
                const res = await apiCall('/api/report');
                
                if (!res.ok) {
                    const err = await res.json();
                    alert(err.detail || 'ç„¡æ³•è¼‰å…¥å ±å‘Š');
                    return;
                }
                
                const data = await res.json();
                
                // é¡¯ç¤ºæ‘˜è¦
                const summary = document.getElementById('report-summary');
                summary.innerHTML = `
                    <div class="bg-gray-700 rounded-lg p-3">
                        <div class="text-xs text-gray-400">BTC åƒ¹æ ¼</div>
                        <div class="text-lg font-bold text-green-400">$${(data.price?.price_usd || 0).toLocaleString()}</div>
                    </div>
                    <div class="bg-gray-700 rounded-lg p-3">
                        <div class="text-xs text-gray-400">24h æ¼²è·Œ</div>
                        <div class="text-lg font-bold ${(data.price?.price_change_24h || 0) >= 0 ? 'text-green-400' : 'text-red-400'}">
                            ${(data.price?.price_change_24h || 0).toFixed(2)}%
                        </div>
                    </div>
                    <div class="bg-gray-700 rounded-lg p-3">
                        <div class="text-xs text-gray-400">ææ…Œè²ªå©ªæŒ‡æ•¸</div>
                        <div class="text-lg font-bold">${data.sentiment?.emoji || ''} ${data.sentiment?.value || '--'}</div>
                    </div>
                    <div class="bg-gray-700 rounded-lg p-3">
                        <div class="text-xs text-gray-400">BTC Dominance</div>
                        <div class="text-lg font-bold">${(data.market_structure?.btc_dominance || 0).toFixed(1)}%</div>
                    </div>
                `;
                
                // é¡¯ç¤º JSON
                document.getElementById('report-json').textContent = JSON.stringify(data, null, 2);
                
                panel.classList.remove('hidden');
                
            } catch (err) {
                alert('è¼‰å…¥å ±å‘Šå¤±æ•—: ' + err.message);
            }
        }
        
        function hideReport() {
            document.getElementById('report-panel').classList.add('hidden');
        }
        
        async function publishSite() {
            if (!confirm('ç¢ºå®šè¦åŸ·è¡Œå®Œæ•´ç™¼å¸ƒæµç¨‹å—ï¼Ÿ\n\né€™å°‡åŸ·è¡Œï¼š\n1. æ¡é›†è³‡æ–™\n2. ç”Ÿæˆæ–‡ç« \n3. å»ºç½®ç¶²ç«™\n4. æ¨é€åˆ° GitHub\n\nï¼ˆç´„éœ€ 1-3 åˆ†é˜ï¼‰')) {
                return;
            }
            
            setButtonsEnabled(false);
            showTaskStatus('â³', 'ç™¼å¸ƒä¸­...', 'Step 1/4: æ­£åœ¨æ¡é›†è³‡æ–™...', true);
            document.getElementById('task-steps').innerHTML = '';
            
            try {
                const res = await apiCall('/api/publish', { method: 'POST' });
                const data = await res.json();
                
                if (res.ok) {
                    showTaskStatus('âœ…', 'ç™¼å¸ƒå®Œæˆ', data.message || 'ç¶²ç«™å·²æˆåŠŸç™¼å¸ƒ');
                    if (data.steps) {
                        showTaskSteps(data.steps);
                    }
                } else {
                    showTaskStatus('âŒ', 'ç™¼å¸ƒå¤±æ•—', data.detail || 'ç™¼ç”ŸéŒ¯èª¤');
                }
            } catch (err) {
                console.error('Publish error:', err);
                showTaskStatus('âŒ', 'ç™¼å¸ƒå¤±æ•—', `ç¶²è·¯éŒ¯èª¤: ${err.message}`);
            } finally {
                setButtonsEnabled(true);
                refreshStatus();
            }
        }
        
        // ============================================
        // åˆå§‹åŒ–
        // ============================================
        
        document.addEventListener('DOMContentLoaded', () => {
            refreshStatus();
            // æ¯ 30 ç§’åˆ·æ–°ä¸€æ¬¡ç‹€æ…‹
            setInterval(refreshStatus, 30000);
        });
    </script>
</body>
</html>
