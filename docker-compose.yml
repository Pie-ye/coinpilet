# ============================================
# CoinPilot AI - Docker Compose 設定
# ============================================
# 使用方式:
#   docker compose build              # 建置映像檔
#   docker compose run --rm app python main.py run
#   docker compose run --rm app python main.py collect
#   docker compose run --rm app python main.py write --mock
#   docker compose run --rm app python main.py build
#   docker compose up serve           # 啟動開發伺服器
# ============================================

services:
  # 主應用程式
  app:
    build:
      context: .
      dockerfile: Dockerfile
    image: coinpilot-ai:latest
    container_name: coinpilot-app
    
    # 環境變數
    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - COPILOT_MODEL=${COPILOT_MODEL:-gemini-3-flash}
      - HUGO_BASE_URL=${HUGO_BASE_URL:-}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    
    # 掛載目錄
    volumes:
      # 資料目錄 (保存採集的 JSON)
      - ./data:/app/data
      # 文章內容 (保存生成的 Markdown)
      - ./site/content/posts:/app/site/content/posts
      # 網站輸出 (保存建置結果)
      - ./site/public:/app/site/public
    
    # 工作目錄
    working_dir: /app
    
    # 預設指令 (可被覆蓋)
    command: ["python", "main.py", "status"]

  # Hugo 開發伺服器
  serve:
    build:
      context: .
      dockerfile: Dockerfile
    image: coinpilot-ai:latest
    container_name: coinpilot-serve
    
    # 掛載整個 site 目錄以支援熱重載
    volumes:
      - ./site:/app/site
    
    # 暴露埠號
    ports:
      - "1313:1313"
    
    # 工作目錄
    working_dir: /app/site
    
    # 啟動 Hugo 開發伺服器
    command: ["hugo", "server", "--bind", "0.0.0.0", "--port", "1313", "--disableFastRender"]

  # 完整流程執行 (一次性任務)
  run:
    build:
      context: .
      dockerfile: Dockerfile
    image: coinpilot-ai:latest
    
    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - COPILOT_MODEL=${COPILOT_MODEL:-gemini-3-flash}
      - HUGO_BASE_URL=${HUGO_BASE_URL:-}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    
    volumes:
      - ./data:/app/data
      - ./site/content/posts:/app/site/content/posts
      - ./site/public:/app/site/public
    
    working_dir: /app
    
    # 執行完整流程 (使用 mock 模式避免需要 Copilot CLI)
    command: ["python", "main.py", "run", "--mock"]

  # Web GUI 控制台
  web:
    build:
      context: .
      dockerfile: Dockerfile
    image: coinpilot-ai:latest
    container_name: coinpilot-web
    
    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - COPILOT_MODEL=${COPILOT_MODEL:-gemini-3-flash}
      - COINGECKO_API_KEY=${COINGECKO_API_KEY:-}
      - HUGO_BASE_URL=${HUGO_BASE_URL:-}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - GIT_USER_NAME=${GIT_USER_NAME:-CoinPilot Bot}
      - GIT_USER_EMAIL=${GIT_USER_EMAIL:-bot@coinpilot.ai}
    
    volumes:
      # 資料與內容目錄
      - ./data:/app/data
      - ./site/content/posts:/app/site/content/posts
      - ./site/public:/app/site/public
      # Git 目錄 (用於推送到 GitHub)
      - ./.git:/app/.git
    
    ports:
      - "8000:8000"
    
    working_dir: /app
    
    # 啟動 Web GUI
    command: ["python", "-m", "uvicorn", "src.api.server:app", "--host", "0.0.0.0", "--port", "8000"]

# 網路設定
networks:
  default:
    name: coinpilot-network
